name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-args: '--prod'
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}

  run-database-migrations:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Install Supabase CLI
      uses: supabase/setup-cli@v1

    - name: Run database migrations
      run: |
        supabase db push --db-url "${{ secrets.SUPABASE_DB_URL }}"
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  notify-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-frontend]
    if: always()

    steps:
    - name: Notify deployment status
      uses: actions/github-script@v6
      with:
        script: |
          const success = '${{ needs.deploy-frontend.result }}' === 'success';
          const emoji = success ? '✅' : '❌';
          const status = success ? 'succeeded' : 'failed';

          const title = `Deployment ${status}`;
          const body = `${emoji} Deployment to production ${status}

          **Details:**
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          - Run: ${{ github.run_id }}
          - Time: ${new Date().toISOString()}

          ${success ? 'The application is now live!' : 'Please check the logs for errors.'}`;

          // You could send this to Slack, Discord, email, etc.
          console.log(title);
          console.log(body);